<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[えやみぐさ RSS Feed]]></title><description><![CDATA[えやみぐさ RSS Feed]]></description><link>https://blog.aoirint.com</link><generator>GatsbyJS</generator><lastBuildDate>Thu, 07 Jul 2022 04:59:47 GMT</lastBuildDate><item><title><![CDATA[Python, asyncioを使った同期・非同期処理の実装例]]></title><description><![CDATA[Python, asyncioを使った同期・非同期処理の実装例 Python 3.9.13 (pyenv) Ubuntu 20.04 (WSL2) https://github.com/aoirint/python_asyncio_examples…]]></description><link>https://blog.aoirint.com/entry/2022/python_asyncio_examples/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/python_asyncio_examples/</guid><pubDate>Thu, 07 Jul 2022 02:20:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;python-asyncioを使った同期非同期処理の実装例&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#python-asyncio%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9F%E5%90%8C%E6%9C%9F%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86%E3%81%AE%E5%AE%9F%E8%A3%85%E4%BE%8B&quot; aria-label=&quot;python asyncioを使った同期非同期処理の実装例 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Python, asyncioを使った同期・非同期処理の実装例&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;Python 3.9.13 (pyenv)&lt;/li&gt;&lt;li&gt;Ubuntu 20.04 (WSL2)&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/aoirint/python_asyncio_examples&quot;&gt;https://github.com/aoirint/python_asyncio_examples&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;なんかこう書くとうまく動くということしかわからん、という実装例です。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://twitter.com/aoirint/status/1544891079786627074&quot;&gt;https://twitter.com/aoirint/status/1544891079786627074&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;基本実装&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E5%9F%BA%E6%9C%AC%E5%AE%9F%E8%A3%85&quot; aria-label=&quot;基本実装 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;基本実装&lt;/h2&gt;&lt;h3 id=&quot;同期関数から非同期関数を同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;同期関数から非同期関数を同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;同期関数から非同期関数を同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;asyncio.run&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
import time

def main():
  async def func():
    await asyncio.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 1

  asyncio.run(func())

  time.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 2

main()

print(&amp;#x27;exited&amp;#x27;) # 3
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;同期関数から非同期関数を非同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;同期関数から非同期関数を非同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;同期関数から非同期関数を非同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;threading.Thread + asyncio.run&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
from concurrent.futures import ThreadPoolExecutor
import threading
import time

def main():
  async def func():
    await asyncio.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 3

  thread = threading.Thread(target=lambda: asyncio.run(func()))
  thread.start()

  time.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 1

main()

print(&amp;#x27;exited&amp;#x27;) # 2
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;非同期関数から同期関数を同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;非同期関数から同期関数を同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;非同期関数から同期関数を同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;ふつうに呼び出す&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
import time

async def main():
  def func():
    time.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 1

  func()

  await asyncio.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 2

asyncio.run(main())

print(&amp;#x27;exited&amp;#x27;) # 3
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;非同期関数から同期関数を非同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;非同期関数から同期関数を非同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;非同期関数から同期関数を非同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;asyncio.new_event_loop + ThreadPoolExecutor + EventLoop.run_in_executor&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
from concurrent.futures import ThreadPoolExecutor
import time

async def main():
  def func():
    time.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 3

  loop = asyncio.new_event_loop()
  executor = ThreadPoolExecutor()
  loop.run_in_executor(executor, func)

  await asyncio.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 1

asyncio.run(main())

print(&amp;#x27;exited&amp;#x27;) # 2
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;非同期関数から非同期関数を同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;非同期関数から非同期関数を同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;非同期関数から非同期関数を同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;awaitキーワード&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio

async def main():
  async def func():
    await asyncio.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 1

  await func()

  await asyncio.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 2

asyncio.run(main())

print(&amp;#x27;exited&amp;#x27;) # 3
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;非同期関数から非同期関数を非同期的に呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;非同期関数から非同期関数を非同期的に呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;非同期関数から非同期関数を非同期的に呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;threading.Thread + asyncio.run&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
import threading

async def main():
  async def func():
    await asyncio.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 3

  thread = threading.Thread(target=lambda: asyncio.run(func()))
  thread.start()

  await asyncio.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 1

asyncio.run(main())

print(&amp;#x27;exited&amp;#x27;) # 2
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;非同期関数から同期間数を非同期的に3つずつ呼び出す&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%96%A2%E6%95%B0%E3%81%8B%E3%82%89%E5%90%8C%E6%9C%9F%E9%96%93%E6%95%B0%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB3%E3%81%A4%E3%81%9A%E3%81%A4%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99&quot; aria-label=&quot;非同期関数から同期間数を非同期的に3つずつ呼び出す permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;非同期関数から同期間数を非同期的に3つずつ呼び出す&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;asyncio.new_event_loop + ThreadPoolExecutor + EventLoop.run_in_executor&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import asyncio
from concurrent.futures import ThreadPoolExecutor
import time

async def main():
  def func():
    time.sleep(3)
    print(&amp;#x27;func exited&amp;#x27;) # 3

  loop = asyncio.new_event_loop()
  executor = ThreadPoolExecutor(max_workers=3)
  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)

  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)

  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)
  loop.run_in_executor(executor, func)

  await asyncio.sleep(1)
  print(&amp;#x27;main exited&amp;#x27;) # 1

asyncio.run(main())

print(&amp;#x27;exited&amp;#x27;) # 2
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h2 id=&quot;よく見るエラー&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E3%82%88%E3%81%8F%E8%A6%8B%E3%82%8B%E3%82%A8%E3%83%A9%E3%83%BC&quot; aria-label=&quot;よく見るエラー permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;よく見るエラー&lt;/h2&gt;&lt;h3 id=&quot;runtimeerror-event-loop-is-closed&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#runtimeerror-event-loop-is-closed&quot; aria-label=&quot;runtimeerror event loop is closed permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RuntimeError: Event loop is closed&lt;/h3&gt;&lt;p&gt;TBW&lt;/p&gt;&lt;h3 id=&quot;runtimeerror-this-event-loop-is-already-running&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#runtimeerror-this-event-loop-is-already-running&quot; aria-label=&quot;runtimeerror this event loop is already running permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;RuntimeError: This event loop is already running&lt;/h3&gt;&lt;p&gt;TBW&lt;/p&gt;&lt;h2 id=&quot;アプリケーション&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3&quot; aria-label=&quot;アプリケーション permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;アプリケーション&lt;/h2&gt;&lt;h3 id=&quot;fastapi--schedule&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#fastapi--schedule&quot; aria-label=&quot;fastapi  schedule permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FastAPI + schedule&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;asyncio.new_event_loop + ThreadPoolExecutor + EventLoop.run_in_executor&lt;/li&gt;&lt;li&gt;threading.Event&lt;/li&gt;&lt;li&gt;Dependencies&lt;ul&gt;&lt;li&gt;fastapi==0.78.0&lt;/li&gt;&lt;li&gt;schedule==1.1.0&lt;/li&gt;&lt;li&gt;uvicorn==0.18.2&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;summary&gt;実行コマンド例&lt;/summary&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot;&gt;uvicorn fastapi_schedule:app
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;details&gt;&lt;summary&gt;コード例&lt;/summary&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import time
import threading
import asyncio
from concurrent.futures import ThreadPoolExecutor
import schedule
from fastapi import FastAPI

app = FastAPI()
schedule_event = threading.Event()

@app.on_event(&amp;#x27;startup&amp;#x27;)
async def startup_schedule():
  loop = asyncio.new_event_loop()
  executor = ThreadPoolExecutor()

  def loop_schedule(event):
    while True:
      if event.is_set():
        break
      schedule.run_pending()
      time.sleep(1)

    print(&amp;#x27;run all existing scheduled jobs&amp;#x27;)
    schedule.run_all()

    print(&amp;#x27;exit schedule&amp;#x27;)

  loop.run_in_executor(executor, loop_schedule, schedule_event)

  schedule.every(1).second.do(lambda: print(&amp;#x27;tick&amp;#x27;))

@app.on_event(&amp;#x27;shutdown&amp;#x27;)
async def shutdown_schedule():
  schedule_event.set()
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;ffmpegを子プロセスとして同期的に実行しつつログを非同期にキャプチャする&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#ffmpeg%E3%82%92%E5%AD%90%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%A8%E3%81%97%E3%81%A6%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A4%E3%81%A4%E3%83%AD%E3%82%B0%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%AB%E3%82%AD%E3%83%A3%E3%83%97%E3%83%81%E3%83%A3%E3%81%99%E3%82%8B&quot; aria-label=&quot;ffmpegを子プロセスとして同期的に実行しつつログを非同期にキャプチャする permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;FFmpegを子プロセスとして同期的に実行しつつログを非同期にキャプチャする&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;FFmpeg 4.2.7-0ubuntu0.1&lt;ul&gt;&lt;li&gt;libx264: --enable-libx264&lt;/li&gt;&lt;li&gt;aac: native&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;details&gt;&lt;summary&gt;実行コマンド例&lt;/summary&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot;&gt;python3 ffmpeg_async.py a.mp4 b.mp4
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;details&gt;&lt;summary&gt;コード例&lt;/summary&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;from asyncio import create_subprocess_exec
import asyncio
from concurrent.futures import ThreadPoolExecutor
from pathlib import Path
import tempfile
import time

async def main(
  input_video_path: Path,
  output_video_path: Path,
):
  output_video_path.parent.mkdir(exist_ok=True, parents=True)

  vcodec: str = &amp;#x27;libx264&amp;#x27;
  acodec: str = &amp;#x27;aac&amp;#x27;

  report_tempfile = tempfile.NamedTemporaryFile(mode=&amp;#x27;w+&amp;#x27;, encoding=&amp;#x27;utf-8&amp;#x27;)
  report_loglevel = 32 # 32: info, 48: debug
  report = f&amp;#x27;file={report_tempfile.name}:level={report_loglevel}&amp;#x27;

  command = [
    &amp;#x27;ffmpeg&amp;#x27;,
    &amp;#x27;-nostdin&amp;#x27;,
    &amp;#x27;-i&amp;#x27;,
    str(input_video_path),
    &amp;#x27;-vcodec&amp;#x27;,
    vcodec,
    &amp;#x27;-acodec&amp;#x27;,
    acodec,
    &amp;#x27;-map&amp;#x27;,
    &amp;#x27;0&amp;#x27;,
    &amp;#x27;-report&amp;#x27;,
    str(output_video_path),
  ]

  proc = await create_subprocess_exec(
    command[0],
    *command[1:],
    env={
      &amp;#x27;FFREPORT&amp;#x27;: report,
    },
  )

  loop = asyncio.new_event_loop()
  executor = ThreadPoolExecutor()

  report_lines = []
  def read_report(report_file):
    report_file.seek(0)
    while True:
        line = report_file.readline()
        if len(line) == 0: # EOF
          if proc.returncode is not None: # process closed and EOF
            break
          time.sleep(0.1)
          continue # for next line written
        if line.endswith(&amp;#x27;\n&amp;#x27;):
          line = line[:-1] # strip linebreak
        report_lines.append(line)
        print(f&amp;#x27;REPORT: {line}&amp;#x27;, flush=True)
    print(&amp;#x27;report closed&amp;#x27;) # closed when process exited

  loop.run_in_executor(executor, read_report, report_tempfile)

  returncode = await proc.wait()
  # stdout, stderr may be not closed
  print(f&amp;#x27;exited {returncode}&amp;#x27;)

  # here, report_lines: ffmpeg log

if __name__ == &amp;#x27;__main__&amp;#x27;:
  import argparse
  parser = argparse.ArgumentParser()
  parser.add_argument(&amp;#x27;input&amp;#x27;, type=str)
  parser.add_argument(&amp;#x27;output&amp;#x27;, type=str)
  args = parser.parse_args()

  input_video_path = Path(args.input)
  output_video_path = Path(args.output)

  asyncio.run(main(
    input_video_path=input_video_path,
    output_video_path=output_video_path,
  ))
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;</content:encoded></item><item><title><![CDATA[nginx, リバースプロキシからのReferrer-Policyヘッダを置換する]]></title><description><![CDATA[nginx, リバースプロキシからのReferrer-Policyヘッダを置換する https://takuya-1st.hatenablog.jp/entry/2018/11/01/040000 https://developer.mozilla.org/ja/docs/Web…]]></description><link>https://blog.aoirint.com/entry/2022/nginx_replace_referrer_policy_header/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/nginx_replace_referrer_policy_header/</guid><pubDate>Fri, 01 Jul 2022 00:00:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;nginx-リバースプロキシからのreferrer-policyヘッダを置換する&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#nginx-%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E3%81%8B%E3%82%89%E3%81%AEreferrer-policy%E3%83%98%E3%83%83%E3%83%80%E3%82%92%E7%BD%AE%E6%8F%9B%E3%81%99%E3%82%8B&quot; aria-label=&quot;nginx リバースプロキシからのreferrer policyヘッダを置換する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;nginx, リバースプロキシからのReferrer-Policyヘッダを置換する&lt;/h1&gt;&lt;pre&gt;&lt;code class=&quot;language-nginx&quot;&gt;add_header Referrer-Policy no-referrer;
# add_header Referrer-Policy same-origin;

proxy_hide_header Referrer-Policy; # remove Referrer-Policy from original response
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://takuya-1st.hatenablog.jp/entry/2018/11/01/040000&quot;&gt;https://takuya-1st.hatenablog.jp/entry/2018/11/01/040000&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Referrer-Policy&quot;&gt;https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Referrer-Policy&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/a/55692346&quot;&gt;https://stackoverflow.com/a/55692346&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;mastodon&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#mastodon&quot; aria-label=&quot;mastodon permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Mastodon&lt;/h2&gt;&lt;p&gt;Mastodonでリファラを送らないようにしたかった。&lt;/p&gt;&lt;p&gt;HTMLタグのmetaタグを使う方法をよく使うのだけれど、
ブログとかによくあるheadタグへの任意HTML追加機能のようなものは
Mastodon v3.5.3にはなさそうだった。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/mastodon/mastodon/issues/9183&quot;&gt;https://github.com/mastodon/mastodon/issues/9183&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;同一オリジンでもリファラを送らないようにする（no-referrer）とMastodonの一部の設定が更新できなくなくなるようなので、
Mastodonでは&lt;code&gt;Referrer-Policy: same-origin&lt;/code&gt;に設定した。&lt;/p&gt;&lt;p&gt;単純に&lt;code&gt;add_header&lt;/code&gt;するだけだと、Mastodonが返す&lt;code&gt;Referrer-Policy&lt;/code&gt;とnginxが追加する&lt;code&gt;Referrer-Policy&lt;/code&gt;で2つのヘッダになってしまった。&lt;/p&gt;&lt;pre&gt;&lt;code&gt;referrer-policy: origin
referrer-policy: no-referrer
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;そこで、&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-nginx&quot;&gt;proxy_hide_header Referrer-Policy;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;でMastodonから返ってきたReferrer-Policyを削除するようにした。&lt;/p&gt;&lt;p&gt;あとは、&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-nginx&quot;&gt;add_header Referrer-Policy same-origin;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;するだけ。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://mstdn.aoirint.com/@aoirint/108569086590516035&quot;&gt;https://mstdn.aoirint.com/@aoirint/108569086590516035&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Django 3.xから4.xへの更新でPOSTリクエスト時にCSRF検証に失敗する]]></title><description><![CDATA[Django 3.xから4.xへの更新でPOSTリクエスト時にCSRF検証に失敗する 想定: 3.xで動いていたフォーム送信が4.xへの更新でCSRF検証に失敗するために動かなくなった settings.py に CSRF_TRUSTED_ORIGINS…]]></description><link>https://blog.aoirint.com/entry/2022/django_3_x_to_4_x_csrf_verification_failed/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/django_3_x_to_4_x_csrf_verification_failed/</guid><pubDate>Fri, 24 Jun 2022 13:10:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;django-3xから4xへの更新でpostリクエスト時にcsrf検証に失敗する&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#django-3x%E3%81%8B%E3%82%894x%E3%81%B8%E3%81%AE%E6%9B%B4%E6%96%B0%E3%81%A7post%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E6%99%82%E3%81%ABcsrf%E6%A4%9C%E8%A8%BC%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%99%E3%82%8B&quot; aria-label=&quot;django 3xから4xへの更新でpostリクエスト時にcsrf検証に失敗する permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Django 3.xから4.xへの更新でPOSTリクエスト時にCSRF検証に失敗する&lt;/h1&gt;&lt;p&gt;想定: 3.xで動いていたフォーム送信が4.xへの更新でCSRF検証に失敗するために動かなくなった&lt;/p&gt;&lt;p&gt;&lt;code&gt;settings.py&lt;/code&gt;に&lt;code&gt;CSRF_TRUSTED_ORIGINS&lt;/code&gt;を追加すればよい。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://docs.djangoproject.com/en/4.0/ref/settings/#std-setting-CSRF_TRUSTED_ORIGINS&quot;&gt;https://docs.djangoproject.com/en/4.0/ref/settings/#std-setting-CSRF_TRUSTED_ORIGINS&lt;/a&gt;&lt;/li&gt;&lt;li&gt;Origin: e.g. &lt;code&gt;https://example.com&lt;/code&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://developer.mozilla.org/ja/docs/Glossary/Origin&quot;&gt;https://developer.mozilla.org/ja/docs/Glossary/Origin&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;CSRF検証のドキュメントを3.xと比べると、以下の記述が増えている。&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;CsrfViewMiddleware verifies the Origin header, if provided by the browser, against the current host and the CSRF_TRUSTED_ORIGINS setting. This provides protection against cross-subdomain attacks.&lt;/p&gt;&lt;/blockquote&gt;&lt;ul&gt;&lt;li&gt;4.x: &lt;a href=&quot;https://docs.djangoproject.com/en/4.0/ref/csrf/#how-it-works&quot;&gt;https://docs.djangoproject.com/en/4.0/ref/csrf/#how-it-works&lt;/a&gt;&lt;/li&gt;&lt;li&gt;3.x: &lt;a href=&quot;https://docs.djangoproject.com/en/3.2/ref/csrf/#how-it-works&quot;&gt;https://docs.djangoproject.com/en/3.2/ref/csrf/#how-it-works&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[GitHub ActionsでPyPIにPythonパッケージをpushする（GitHub Release連携でバージョン付け）]]></title><description><![CDATA[GitHub ActionsでPyPIにPythonパッケージをpushする（GitHub Release連携でバージョン付け） https://qiita.com/aoirint/items/09ea153751a65bf4876f#github-release%E4%BD…]]></description><link>https://blog.aoirint.com/entry/2022/github_actions_push_to_pypi/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/github_actions_push_to_pypi/</guid><pubDate>Fri, 24 Jun 2022 09:20:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;github-actionsでpypiにpythonパッケージをpushするgithub-release連携でバージョン付け&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-actions%E3%81%A7pypi%E3%81%ABpython%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92push%E3%81%99%E3%82%8Bgithub-release%E9%80%A3%E6%90%BA%E3%81%A7%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E4%BB%98%E3%81%91&quot; aria-label=&quot;github actionsでpypiにpythonパッケージをpushするgithub release連携でバージョン付け permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub ActionsでPyPIにPythonパッケージをpushする（GitHub Release連携でバージョン付け）&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://qiita.com/aoirint/items/09ea153751a65bf4876f#github-release%E4%BD%9C%E6%88%90%E6%99%82%E3%81%ABpypi%E3%81%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89&quot;&gt;https://qiita.com/aoirint/items/09ea153751a65bf4876f#github-release%E4%BD%9C%E6%88%90%E6%99%82%E3%81%ABpypi%E3%81%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;上の記事のWorkflowテンプレートをちょっと改良した。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;GitHub Release作成時にリリースタグをパッケージバージョンにしてpush&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;構成&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E6%A7%8B%E6%88%90&quot; aria-label=&quot;構成 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;構成&lt;/h2&gt;&lt;p&gt;&lt;code&gt;mypackage/__init__.py&lt;/code&gt;に以下のように開発用のバージョン情報を記述する。
リリース時にGithub Actionsでリリースタグに置換してからPyPIにpushする。&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;__VERSION__ = &amp;#x27;0.0.0&amp;#x27;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;github-secrets&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-secrets&quot; aria-label=&quot;github secrets permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Secrets&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;PYPI_API_TOKEN&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;github-workflow-githubworkflowspypiyml&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-workflow-githubworkflowspypiyml&quot; aria-label=&quot;github workflow githubworkflowspypiyml permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Workflow .github/workflows/pypi.yml&lt;/h2&gt;&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;name: Publish a package to PyPI

on:
  release:
    types:
      - created

env:
  VERSION: ${{ github.event.release.tag_name != &amp;#x27;&amp;#x27; &amp;amp;&amp;amp; github.event.release.tag_name || &amp;#x27;0.0.0&amp;#x27; }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: |
            pip3 install -r requirements.txt
            pip3 install wheel
      - name: Replace version
        run: |
          sed -i &amp;quot;s/__VERSION__ = &amp;#x27;0.0.0&amp;#x27;/__VERSION__ = &amp;#x27;${{ env.VERSION }}&amp;#x27;/&amp;quot; mypackage/__init__.py
      - name: Build Package
        run: python3 setup.py sdist bdist_wheel

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
&lt;/code&gt;&lt;/pre&gt;</content:encoded></item><item><title><![CDATA[GitHub ActionsでDocker RegistryにDockerイメージをpushする（latestタグ、GitHub Release連携でバージョン付け）]]></title><description><![CDATA[GitHub ActionsでDocker RegistryにDockerイメージをpushする（latestタグ、GitHub Release連携でバージョン付け） https://blog.aoirint.com/entry/2021/github_actions…]]></description><link>https://blog.aoirint.com/entry/2022/github_actions_push_to_docker_registry_versioned/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/github_actions_push_to_docker_registry_versioned/</guid><pubDate>Fri, 24 Jun 2022 09:10:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;github-actionsでdocker-registryにdockerイメージをpushするlatestタグgithub-release連携でバージョン付け&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-actions%E3%81%A7docker-registry%E3%81%ABdocker%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92push%E3%81%99%E3%82%8Blatest%E3%82%BF%E3%82%B0github-release%E9%80%A3%E6%90%BA%E3%81%A7%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E4%BB%98%E3%81%91&quot; aria-label=&quot;github actionsでdocker registryにdockerイメージをpushするlatestタグgithub release連携でバージョン付け permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub ActionsでDocker RegistryにDockerイメージをpushする（latestタグ、GitHub Release連携でバージョン付け）&lt;/h1&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://blog.aoirint.com/entry/2021/github_actions_docker_io_token/&quot;&gt;https://blog.aoirint.com/entry/2021/github_actions_docker_io_token/&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;上の記事のWorkflowテンプレートをちょっと改良した。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Docker Hub以外のDockerレジストリに対応&lt;/li&gt;&lt;li&gt;GitHub Release作成時にリリースタグをイメージタグにしてpush&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;レジストリurl&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#%E3%83%AC%E3%82%B8%E3%82%B9%E3%83%88%E3%83%AAurl&quot; aria-label=&quot;レジストリurl permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;レジストリURL&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;Docker Hub: &lt;code&gt;docker.io&lt;/code&gt;&lt;/li&gt;&lt;li&gt;GitHub Container Registry: &lt;code&gt;ghcr.io&lt;/code&gt;&lt;/li&gt;&lt;li&gt;GitLab Container Registry: &lt;code&gt;registry.gitlab.com&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;github-secrets&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-secrets&quot; aria-label=&quot;github secrets permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Secrets&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;DOCKER_USERNAME&lt;/li&gt;&lt;li&gt;DOCKER_TOKEN&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;github-workflow-githubworkflowsdockeryml&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#github-workflow-githubworkflowsdockeryml&quot; aria-label=&quot;github workflow githubworkflowsdockeryml permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GitHub Workflow .github/workflows/docker.yml&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/docker/login-action&quot;&gt;https://github.com/docker/login-action&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/docker/build-push-action&quot;&gt;https://github.com/docker/build-push-action&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;name: Push to Docker registry

on:
  push:
    branches:
      - main
  release:
    types:
      - created

env:
  IMAGE_NAME: docker.io/username/imagename
  IMAGE_TAG: ${{ github.event.release.tag_name != &amp;#x27;&amp;#x27; &amp;amp;&amp;amp; github.event.release.tag_name || &amp;#x27;latest&amp;#x27; }}

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and Deploy Docker image
        uses: docker/build-push-action@v3
        env:
          IMAGE_NAME_AND_TAG: ${{ format(&amp;#x27;{0}:{1}&amp;#x27;, env.IMAGE_NAME, env.IMAGE_TAG) }}
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: ./Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME_AND_TAG }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME_AND_TAG }}-buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME_AND_TAG }}-buildcache,mode=max
&lt;/code&gt;&lt;/pre&gt;</content:encoded></item><item><title><![CDATA[pip-compileでMetadataGenerationFailedの例外が起きる]]></title><description><![CDATA[pip-compileでMetadataGenerationFailedの例外が起きる pip-compileは、pip-toolsパッケージ（jazzband/pip-tools）に含まれるコマンドで、
Pythonパッケージのリスト requirements.in…]]></description><link>https://blog.aoirint.com/entry/2022/pip_compile_metadata_generation_failed/</link><guid isPermaLink="false">https://blog.aoirint.com/entry/2022/pip_compile_metadata_generation_failed/</guid><pubDate>Fri, 24 Jun 2022 07:10:00 GMT</pubDate><content:encoded>&lt;h1 id=&quot;pip-compileでmetadatagenerationfailedの例外が起きる&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#pip-compile%E3%81%A7metadatagenerationfailed%E3%81%AE%E4%BE%8B%E5%A4%96%E3%81%8C%E8%B5%B7%E3%81%8D%E3%82%8B&quot; aria-label=&quot;pip compileでmetadatagenerationfailedの例外が起きる permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;pip-compileでMetadataGenerationFailedの例外が起きる&lt;/h1&gt;&lt;p&gt;pip-compileは、pip-toolsパッケージ（jazzband/pip-tools）に含まれるコマンドで、
Pythonパッケージのリスト&lt;code&gt;requirements.in&lt;/code&gt;から、
依存ツリーのライブラリバージョンリスト&lt;code&gt;requirements.txt&lt;/code&gt;を出力してくれる便利なツールである。&lt;/p&gt;&lt;details&gt;&lt;summary&gt;入力例 requirements.in&lt;/summary&gt;&lt;pre&gt;&lt;code&gt;django
requests
gunicorn
mysqlclient
python-dateutil
requests-oauthlib
schedule
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot;&gt;pip-compile requirements.in
&lt;/code&gt;&lt;/pre&gt;&lt;details&gt;&lt;summary&gt;出力例 requirements.txt&lt;/summary&gt;&lt;pre&gt;&lt;code&gt;#
# This file is autogenerated by pip-compile with python 3.8
# To update, run:
#
#    pip-compile requirements.in
#
asgiref==3.5.2
    # via django
backports-zoneinfo==0.2.1
    # via django
certifi==2022.6.15
    # via requests
charset-normalizer==2.0.12
    # via requests
django==4.0.5
    # via -r requirements.in
gunicorn==20.1.0
    # via -r requirements.in
idna==3.3
    # via requests
mysqlclient==2.1.1
    # via -r requirements.in
oauthlib==3.2.0
    # via requests-oauthlib
python-dateutil==2.8.2
    # via -r requirements.in
requests==2.28.0
    # via
    #   -r requirements.in
    #   requests-oauthlib
requests-oauthlib==1.3.1
    # via -r requirements.in
schedule==1.1.0
    # via -r requirements.in
six==1.16.0
    # via python-dateutil
sqlparse==0.4.2
    # via django
urllib3==1.26.9
    # via requests

# The following packages are considered to be unsafe in a requirements file:
# setuptools
&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://pypi.org/project/pip-tools/&quot;&gt;https://pypi.org/project/pip-tools/&lt;/a&gt; （現在 pip-tools==6.6.2）&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/jazzband/pip-tools&quot;&gt;https://github.com/jazzband/pip-tools&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ところでPythonパッケージは、システムパッケージの事前インストールを要求することがある。
以下、システムパッケージ名はDebian/Ubuntuを想定する。&lt;/p&gt;&lt;p&gt;依存先が動的ライブラリであれば、モジュールのimport時に例外を投げる作りになっている場合もあるが、
Pythonパッケージのインストールと同時にC言語コードからネイティブバイナリをコンパイルするような作りになっている場合には、
コンパイラや依存関係のヘッダファイルなどが必要になることがある。&lt;/p&gt;&lt;p&gt;このような依存関係が不足しているとき、pip-compileは以下のようなエラーログを出力する。&lt;/p&gt;&lt;pre&gt;&lt;code&gt;pip._internal.exceptions.MetadataGenerationFailed: metadata generation failed
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ただし、このエラーログが出力されたとき、必ずしも原因が依存関係の不足とは限らない点は指摘しておく。
いまのところpip-compileには、パッケージのインストール処理が記述されたsetup.pyの実行時に例外が起きたとき、その例外の内容が隠されてしまう問題があり、他に原因がある可能性もある。
他に原因がありそうなときには、venvで仮想環境を作るなどして、一度通常のpip installを実行してみて、エラーログを確認して対処するとよいと思う。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/jazzband/pip-tools/issues/1583&quot;&gt;https://github.com/jazzband/pip-tools/issues/1583&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ともあれ、このようなpipに管理されていない依存関係は、
ドキュメントが整備されている通常のPythonパッケージであれば、
PyPIやパッケージの公式ドキュメントに利用者向けの記載があるはずなので、
そちらを確認してインストールしてからpip-compileを実行すると解消するだろう。&lt;/p&gt;&lt;p&gt;例えば、PostgreSQLドライバのpsycopg2は、以下のようなパッケージの事前インストールが必要である。&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Cコンパイラ&lt;/li&gt;&lt;li&gt;Pythonのヘッダ&lt;/li&gt;&lt;li&gt;Postgresライブラリlibpqのヘッダ&lt;/li&gt;&lt;/ul&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot;&gt;sudo apt install python3-dev libpq-dev build-essential
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://pypi.org/project/psycopg2/&quot;&gt;https://pypi.org/project/psycopg2/&lt;/a&gt; （現在 psycopg2==2.9.3）&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://www.psycopg.org/docs/install.html#build-prerequisites&quot;&gt;https://www.psycopg.org/docs/install.html#build-prerequisites&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;MySQLドライバのmysqlclientは、以下のようなパッケージの事前インストールが必要である。&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-shell&quot;&gt;sudo apt install python3-dev default-libmysqlclient-dev build-essential
&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://pypi.org/project/mysqlclient/&quot;&gt;https://pypi.org/project/mysqlclient/&lt;/a&gt; （現在 mysqlclient==2.1.1）&lt;/li&gt;&lt;/ul&gt;</content:encoded></item></channel></rss>